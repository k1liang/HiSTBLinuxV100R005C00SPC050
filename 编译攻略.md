# 刷华为海思机顶盒hi3798mv100

(具体流程也可以参考https://www.ecoo.top/，固件都是从此下来的)

1. 打开机顶盒设置，高级设置，密码10010，关掉升级
2. 开启设置中远程维护调试
3. 打开stb 4.0.3(7.0不好用），密码.287aW，Ip 192.168.1.7，点击连接，右下启用远程登陆“开”，提交
4. gitbash上执行adb connect 192.168.1.7
5. adb devices下看看对不对，对的话adb shell
6.  `# cat /dev/block/mmcblk0p1 | grep -a hi3798 确认下是不是:54hi3798mdmo1g`
7. 将emmc-hi3798mdmo1g-20220808内img考到u盘插入机顶盒
8. dd if=/mnt/sda/sda1/emmc-hi3798mdmo1g-20220808.img of=/dev/block/mmcblk0 很慢，完成后重启盒子拔掉u盘
9. 重启后在路由里看到机顶盒ip（192.168.1.6），可通过浏览器直接输入http://192.168.1.6看到界面，或者输入http://192.168.1.6:7681，默认用户root


# 通过python安装homeassistent

1. 更新系统
	```sudo apt-get update -y```

2. 在线更新python版本为3.9(注意ha要求py版本)
	```sudo apt-get install python3.9 python3.9-dev -y```

3. 安装python3.9虚拟环境
	```sudo sudo apt-get install python3.9-venv```

4. 创建homeassistant虚拟目录和激活虚拟环境
	```
	sudo python3.9 -m venv homeassistant
	source homeassistant/bin/activate
	```

5. 安装homeassistant

	```pip install --upgrade pip```

执行pip install homeassistant，如果有报错依次安装以下：

```
	sudo apt -y install build-essential libssl-dev libffi-dev python-dev libxml2-dev libxslt-dev libjpeg-dev zlib1g-dev 
	sudo apt -y install rustc cargo 
	pip install --upgrade pip
	pip install wheel
	pip install lxml Pillow numpy PyTurboJPEG
	pip install cryptography
	pip install homeassistant 
```

如果install homeassistent的时候遇到multidict错误，那么
```
	sudo apt remove rustc
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

参考： https://community.home-assistant.io/t/error-failed-building-wheel-for-cryptography-while-moving-home-assistant-from-python-3-8-to-3-9/370470

6. 安装成功界面

7. 启动homeassistant
	```
	// 第一次运行建议上verbose，看看有没有报错，后面就不用装个命令了
	// hass --verbose	
	
	// 后台运行hass
	nohup hass > hass.log 2>&1 &
	// tail查看日志
	tail hass.log
	// 以后ssh连接后可以直接执行以下命令激活虚拟环境
	source /srv/homeassistant/bin/activate
	// 退出虚拟环境
	deactivate
	```

8. web打开Homeassistant平台默认端口8123：http://192.168.1.6:8123/


## 参考资料：
```
https://www.jianshu.com/p/8a991626dba5
https://www.home-assistant.io/installation/raspberrypi
Hadymic https://www.bilibili.com/read/cv17279212 出处：bilibili
https://www.zigbee2mqtt.io/guide/installation/07_python_virtual_environment.html#installing
```


# 如何编linux

1. 用vmware装个ubuntu
2. 下载 https://github.com/k1liang/HiSTBLinuxV100R005C00SPC050 到ubuntu
3. sudo apt-get install gcc make gettext bison flex bc zlib1g-dev libncurses5-dev lzma
4. cd HiSTBLinuxV100R005C00SPC050
```
	source ./env.sh
	cp configs/hi3798mv100/hi3798mdmo1g_hi3798mv100_cfg.mak ./cfg.mak
	make menuconfig (没什么可选的直接exit即可）
```
5. cd source/kernel/linux-4.4.y/
```
	make ARCH=arm hi3798mv100_defconfig
	make ARCH=arm menuconfig
	cp .config ./arch/arm/configs/hi3798mv100_defconfig
	make distclean
```
6. cd HiSTBLinuxV100R005C00SPC050
```
	make linux  (编linux）
```
PS： 在编的过程中可能有个XXX_CONFIG编译器不支持，这个搜一下文件给注掉就好了

# 如何编ch34x驱动（路子超野，单独编搞不定环境问题，所以直接对kernel makefile下手了）

1. 按照https://www.cnblogs.com/huang-y-x/p/10747849.html 下载好驱动.c
2. 修改驱动文件夹下makefile（路径自己改）：
	KERNELDIR := /nastmp/HiSTBLinuxV100R005C00SPC050-master/out/hi3798mv100/hi3798mdmo1g/obj/source/kernel/linux-4.4.y
	PWD :=/nastmp/CH341SER_LINUX
3. 打开HiSTBLinuxV100R005C00SPC050目录下MakeFile找到 linux_clean，下面加上俩命令
```
ch340:
	$(AT)make -C $(KERNEL_DIR) ch340
	
modules:
	$(AT)make -C $(KERNEL_DIR) modules	
```

4. 打开HiSTBLinuxV100R005C00SPC050/source/kernel目录下MakeFile找到 distclean，上面加上俩命令
```
ch340: 
	$(AT)make -C /nastmp/CH341SER_LINUX ARCH=$(CFG_HI_CPU_ARCH) \
		CROSS_COMPILE=$(CROSS_COMPILE) \
		$(EXTRA_FLAGS_KERNEL) \
		CFLAGS_KERNEL=$(CFLAGS_KERNEL) \
		AFLAGS_KERNEL=$(AFLAGS_KERNEL)

modules: 
	$(AT)make -C $(KERNEL_SRC_DIR) ARCH=$(CFG_HI_CPU_ARCH) \
		CROSS_COMPILE=$(CROSS_COMPILE) \
		O=$(BUILD_DIR) \
		$(EXTRA_FLAGS_KERNEL) \
		CFLAGS_KERNEL=$(CFLAGS_KERNEL) \
		AFLAGS_KERNEL=$(AFLAGS_KERNEL) modules
```

5.  打开HiSTBLinuxV100R005C00SPC050/source/kernel/linux-4.4.y目录下MakeFile找到 distclean，下面加上命令
```
	ch340: $(Q)$(MAKE) -C /nastmp/CH341SER_LINUX
```

6. 按照上面如何编linux走完前5步，第六步执行make modules，成功后执行make ch340，成功后就能在/nastmp/CH341SER_LINUX找到ch34x.ko, 

7. cd到CH341SER_LINUX，modinfo ch34x.ko下，看看vermagic是多少，记下来，然后
```
	apt-get install binutils-arm-linux-gnueabi
```
准备更改驱动内vermagic

8.  登录机顶盒系统，uname -r 下看看本机系统版本名是多少（比如我本地是4.4.35_ecoo_81080868)，然后回虚拟机修改.ko vermagic（如果虚拟机生成的ko内的vermagic和机顶盒uname -r 出来的一样，那么可以跳过此步）

```
	arm-linux-gnueabi-objcopy ./ch34x.ko  /dev/null --dump-section .modinfo=mod_info
	# 将ko中4.4.35_s40修改为4.4.35_ecoo_81080868
	sed "s/4.4.35_s40/4.4.35_ecoo_81080868" -i mod_info
	arm-linux-gnueabi-objcopy --remove-section=.modinfo --add-section .modinfo=mod_info  ch34x.ko
	# 使用此命令确认下是否修改成功
	modinfo ch34x.ko
```
9. 如果上面步驟不好使，那么直接修改source\kernel\linux-4.4.y\scripts\setlocalversion文件，内容：

```
	# 将 res="${res}${CONFIG_LOCALVERSION}${LOCALVERSION}" 修改为
	res="${res}_ecoo_81080868"
```
然后make modules and make ch340


10. 回到机顶盒系统
```
	apt update && apt install -y kmod
	# 如果有此目录就不用创了
	mkdir -p /lib/modules/
	mkdir -p /lib/modules/4.4.35_ecoo_81080868/modules.builtin
	mkdir -p /lib/modules/4.4.35_ecoo_81080868/modules.order
	# 将ch34x.ko 拷贝到/lib/modules/4.4.35_ecoo_81080868/modules中
	depmod
	modprobe ch34x
```
	如果一切顺利那么驱动安装成功

## 参考资料
	https://bbs.histb.com/d/18-wifi
	https://www.cnblogs.com/huang-y-x/p/10747849.html
	https://www.right.com.cn/forum/forum.php?mod=viewthread&page=1&tid=7269215
	https://yairgadelov.me/linux-module-magic-info/